---
import { languages } from "@/i18n/ui";

const { pathname } = Astro.url;
const currentLang = Astro.currentLocale || "en";

function getPathForLang(lang: string) {
	// Filter empty strings from split to avoid issues with leading/trailing slashes
	const segments = pathname.split("/").filter(Boolean);

	// Check if the first segment is a known language code
	if (segments.length > 0 && Object.keys(languages).includes(segments[0])) {
		segments[0] = lang;
	} else {
		// If no language prefix, prepend the new language
		segments.unshift(lang);
	}

	return `/${segments.join("/")}`;
}
---

<div class="relative ml-2">
	<button
		id="language-toggle"
		type="button"
		class="inline-flex items-center gap-1 rounded-lg p-2 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors"
		aria-label="Change language"
	>
		<span class="font-medium text-sm">{currentLang.toUpperCase()}</span>
		<svg
			xmlns="http://www.w3.org/2000/svg"
			width="16"
			height="16"
			viewBox="0 0 24 24"
			fill="none"
			stroke="currentColor"
			stroke-width="2"
			stroke-linecap="round"
			stroke-linejoin="round"
			class="lucide lucide-chevron-down opacity-60"
		>
			<path d="m6 9 6 6 6-6"></path>
		</svg>
	</button>

	<div
		id="language-menu"
		class="absolute right-0 top-full mt-2 hidden w-32 rounded-lg border border-zinc-200 bg-white py-1 shadow-lg dark:border-zinc-700 dark:bg-zinc-900 z-50 animate-in fade-in slide-in-from-top-2 duration-200"
	>
		{
			Object.entries(languages).map(([lang, label]) => (
				<a
					href={getPathForLang(lang)}
					class:list={[
						"block px-4 py-2 text-sm transition-colors hover:bg-zinc-100 dark:hover:bg-zinc-800",
						{ "font-bold text-blue-600 dark:text-blue-400": lang === currentLang },
						{ "text-zinc-700 dark:text-zinc-300": lang !== currentLang },
					]}
				>
					{label}
				</a>
			))
		}
	</div>
</div>

<script>
	// Run once when the module loads
	document.addEventListener('click', (e) => {
		const menu = document.getElementById('language-menu');
		const toggle = document.getElementById('language-toggle');

		// Close if clicked outside
		if (menu && !menu.classList.contains('hidden')) {
			if (!menu.contains(e.target as Node) && !toggle?.contains(e.target as Node)) {
				menu.classList.add('hidden');
			}
		}
	});

	// Run on every navigation
	document.addEventListener('astro:page-load', () => {
		const toggle = document.getElementById('language-toggle');
		const menu = document.getElementById('language-menu');

		if (toggle && menu) {
			toggle.addEventListener('click', (e) => {
				e.stopPropagation();
				menu.classList.toggle('hidden');
			});
		}
	});
</script>
